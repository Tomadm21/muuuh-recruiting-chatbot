{% extends "admin/base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Analytics</h1>
    <div style="font-size:0.9rem; color:var(--text-secondary);">Overview of your pipeline performance</div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- KPI Cards -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:24px; margin-bottom:40px;">
    <!-- Card 1: Total -->
    <div style="background:var(--bg-card); padding:24px; border-radius:8px; border:1px solid var(--border-subtle);">
        <div
            style="font-size:0.85rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">
            Total Candidates</div>
        <div style="font-size:2rem; font-weight:700; color:var(--text-primary);">{{ leads|length }}</div>
    </div>
    <!-- Card 2: Quality -->
    <div style="background:var(--bg-card); padding:24px; border-radius:8px; border:1px solid var(--border-subtle);">
        <div
            style="font-size:0.85rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">
            High Potential (>80)</div>
        <div style="font-size:2rem; font-weight:700; color:#10b981;">{{ stats.scores[0] }}</div>
    </div>
    <!-- Card 3: Actionable -->
    <div style="background:var(--bg-card); padding:24px; border-radius:8px; border:1px solid var(--border-subtle);">
        <div
            style="font-size:0.85rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">
            Active Pipeline</div>
        <div style="font-size:2rem; font-weight:700; color:#3b82f6;">{{ stats.funnel[1] }}</div>
    </div>
</div>

<!-- Charts Grid -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:24px; margin-bottom:60px;">
    <div style="background:var(--bg-card); padding:30px; border-radius:8px; border:1px solid var(--border-subtle);">
        <h3 style="margin:0 0 24px 0; font-size:1rem; font-weight:600;">Pipeline Funnel</h3>
        <div style="height:220px;">
            <canvas id="funnelChart"></canvas>
        </div>
    </div>
    <div style="background:var(--bg-card); padding:30px; border-radius:8px; border:1px solid var(--border-subtle);">
        <h3 style="margin:0 0 24px 0; font-size:1rem; font-weight:600;">Quality Index</h3>
        <div style="height:220px;">
            <canvas id="qualityChart"></canvas>
        </div>
    </div>
    <div style="background:var(--bg-card); padding:30px; border-radius:8px; border:1px solid var(--border-subtle);">
        <h3 style="margin:0 0 24px 0; font-size:1rem; font-weight:600;">Sources</h3>
        <div style="height:220px;">
            <canvas id="sourceChart"></canvas>
        </div>
    </div>
</div>

<div class="page-header" style="margin-bottom:20px;">
    <h2 class="page-title" style="font-size:1.25rem;">Recent Applications</h2>
</div>

<div style="background:var(--bg-card); border-radius:8px; border:1px solid var(--border-subtle); overflow:hidden;">
    <table class="monday-table" style="margin:0;">
        <thead>
            <tr>
                <th style="padding-left:24px;">Candidate</th>
                <th>Position</th>
                <th>Score</th>
                <th>Status</th>
                <th>Date</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads[:10] %}
            <tr onclick="window.location.href='/admin/lead/{{ lead.id }}'" style="cursor:pointer;">
                <td style="padding-left:24px;">
                    <span style="font-weight:500; color:var(--text-primary);">{{ lead.name or lead.whatsapp_number
                        }}</span>
                </td>
                <td>{{ lead.position_interest or "-" }}</td>
                <td>
                    {% if lead.qualification_score > 0 %}
                    <span
                        style="font-weight:600; color: {% if lead.qualification_score >= 80 %}#10b981{% elif lead.qualification_score >= 50 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ lead.qualification_score }}
                    </span>
                    {% else %}
                    <span style="color:var(--text-tertiary);">-</span>
                    {% endif %}
                </td>
                <td><span class="status-pill status-{{ lead.pipeline_status }}">{{ lead.pipeline_status|capitalize
                        }}</span></td>
                <td style="color:var(--text-secondary); font-size:0.85rem;">{{ lead.updated_at.strftime('%d. %b %Y') }}
                </td>
                <td style="text-align:right; padding-right:24px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-tertiary);">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const stats = {{ stats | tojson }};

    // Global Defaults for Minimal Charts
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    Chart.defaults.scale.grid.display = false;
    
    // 1. Funnel (Doughnut)
    new Chart(document.getElementById('funnelChart'), {
        type: 'doughnut',
        data: {
            labels: ['New', 'In Progress', 'Completed'],
            datasets: [{
                data: stats.funnel,
                backgroundColor: ['#e5e7eb', '#3b82f6', '#10b981'], // Gray, Blue, Green
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
            },
            cutout: '70%'
        }
    });

    // 2. Scores (Bar)
    new Chart(document.getElementById('qualityChart'), {
        type: 'bar',
        data: {
            labels: ['Top', 'Mid', 'Low'],
            datasets: [{
                label: 'Candidates',
                data: stats.scores,
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderRadius: 4,
                barThickness: 40
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f3f4f6', drawBorder: false } },
                x: { grid: { display: false } }
            }
        }
    });

    // 3. Sources (Pie)
    new Chart(document.getElementById('sourceChart'), {
        type: 'pie',
        data: {
            labels: stats.sources_labels,
            datasets: [{
                data: stats.sources_data,
                backgroundColor: ['#111827', '#4b5563', '#9ca3af', '#d1d5db', '#e5e7eb'], // Monochromes
                borderWidth: 0
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
            }
        }
    });
</script>
{% endblock %}