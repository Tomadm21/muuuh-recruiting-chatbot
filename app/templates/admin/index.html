{% extends "admin/base.html" %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Analytics</h1>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Section: Quick Overview -->
<div style="margin-bottom:48px;">
    <h2 style="font-size:0.875rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; margin:0 0 20px 0;">Quick Overview</h2>

<!-- Pipeline At-a-Glance -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-bottom:32px;">
    <!-- New Applicants -->
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <h3 style="margin:0 0 14px 0; font-size:0.75rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.8px; display:flex; align-items:center; gap:6px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            New Applicants
        </h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
            {% set new_leads = [] %}
            {% for lead in leads %}
                {% if lead.pipeline_status == 'NEW' and new_leads|length < 3 %}
                    {% set _ = new_leads.append(lead) %}
                {% endif %}
            {% endfor %}

            {% if new_leads %}
                {% for lead in new_leads %}
                <div onclick="openDrawer('{{ lead.id }}')" style="padding:10px; background:var(--bg-hover); border-radius:6px; cursor:pointer; transition:all 0.15s; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div class="avatar-circle" style="width:24px; height:24px; font-size:0.625rem;">
                            {{ lead.name[:2] if lead.name else '??' }}
                        </div>
                        <span style="font-size:0.8125rem; font-weight:500; color:var(--text-primary);">{{ lead.name or lead.whatsapp_number }}</span>
                    </div>
                    <span style="font-size:0.75rem; color:var(--text-tertiary);">{{ lead.updated_at.strftime('%d %b') }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align:center; padding:20px; color:var(--text-tertiary); font-size:0.75rem;">No new applicants</div>
            {% endif %}
        </div>
    </div>

    <!-- High Priority -->
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <h3 style="margin:0 0 14px 0; font-size:0.75rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.8px; display:flex; align-items:center; gap:6px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
            Top Candidates
        </h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
            {% set top_candidates = [] %}
            {% for lead in leads %}
                {% if lead.qualification_score >= 70 %}
                    {% set _ = top_candidates.append(lead) %}
                {% endif %}
            {% endfor %}

            {% if top_candidates %}
                {% for lead in top_candidates[:3] %}
                <div onclick="openDrawer('{{ lead.id }}')" style="padding:10px; background:var(--bg-hover); border-radius:6px; cursor:pointer; transition:all 0.15s; display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div class="avatar-circle" style="width:24px; height:24px; font-size:0.625rem;">
                            {{ lead.name[:2] if lead.name else '??' }}
                        </div>
                        <span style="font-size:0.8125rem; font-weight:500; color:var(--text-primary);">{{ lead.name or lead.whatsapp_number }}</span>
                    </div>
                    <span style="font-size:0.8125rem; font-weight:700; color:#10b981;">{{ lead.qualification_score }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align:center; padding:20px; color:var(--text-tertiary); font-size:0.75rem;">No high-scoring candidates yet</div>
            {% endif %}
        </div>
    </div>
</div>
</div>

<!-- Section: Key Metrics -->
<div style="margin-bottom:48px;">
    <h2 style="font-size:0.875rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; margin:0 0 20px 0;">Key Metrics</h2>

<!-- KPI Cards -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:32px;">
    <!-- Card 1: Total -->
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <div
            style="font-size:0.6875rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:6px;">
            Total Candidates</div>
        <div style="font-size:1.75rem; font-weight:700; color:var(--text-primary);">{{ leads|length }}</div>
    </div>
    <!-- Card 2: Quality -->
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <div
            style="font-size:0.6875rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:6px;">
            High Potential</div>
        <div style="font-size:1.75rem; font-weight:700; color:#10b981;">{{ stats.scores[0] }}</div>
    </div>
    <!-- Card 3: Actionable -->
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <div
            style="font-size:0.6875rem; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:6px;">
            In Progress</div>
        <div style="font-size:1.75rem; font-weight:700; color:#3b82f6;">{{ stats.funnel[1] }}</div>
    </div>
</div>
</div>

<!-- Section: Analytics -->
<div style="margin-bottom:48px;">
    <h2 style="font-size:0.875rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; margin:0 0 20px 0;">Performance Charts</h2>

<!-- Charts Grid -->
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px; margin-bottom:48px;">
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <h3 style="margin:0 0 20px 0; font-size:0.875rem; font-weight:600; color:var(--text-primary);">Pipeline Funnel</h3>
        <div style="height:200px;">
            <canvas id="funnelChart"></canvas>
        </div>
    </div>
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <h3 style="margin:0 0 20px 0; font-size:0.875rem; font-weight:600; color:var(--text-primary);">Quality Distribution</h3>
        <div style="height:200px;">
            <canvas id="qualityChart"></canvas>
        </div>
    </div>
    <div style="background:var(--bg-card); padding:24px; border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md);">
        <h3 style="margin:0 0 20px 0; font-size:0.875rem; font-weight:600; color:var(--text-primary);">Sources</h3>
        <div style="height:200px;">
            <canvas id="sourceChart"></canvas>
        </div>
    </div>
</div>
</div>

<!-- Section: Recent Activity -->
<div style="margin-bottom:48px;">
    <h2 style="font-size:0.875rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.8px; margin:0 0 20px 0;">Recent Candidates</h2>

<div style="background:var(--bg-card); border-radius:10px; border:2px solid var(--border-medium); box-shadow:var(--shadow-md); overflow:hidden;">
    <table class="monday-table" style="margin:0; border-spacing:0;">
        <thead>
            <tr>
                <th style="padding-left:20px;">Candidate</th>
                <th>Position</th>
                <th>Score</th>
                <th>Status</th>
                <th style="padding-right:20px;">Date</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads[:10] %}
            <tr onclick="openDrawer('{{ lead.id }}')" style="cursor:pointer;">
                <td style="padding-left:20px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="avatar-circle">
                            {{ lead.name[:2] if lead.name else '??' }}
                        </div>
                        <span style="font-weight:500; color:var(--text-primary);">
                            {{ lead.name or lead.whatsapp_number }}
                        </span>
                    </div>
                </td>
                <td style="color:var(--text-secondary);">{{ lead.position_interest or "-" }}</td>
                <td>
                    {% if lead.qualification_score > 0 %}
                    <span
                        style="font-weight:600; font-size:0.875rem; color: {% if lead.qualification_score >= 80 %}#10b981{% elif lead.qualification_score >= 50 %}#f59e0b{% else %}#ef4444{% endif %}">
                        {{ lead.qualification_score }}
                    </span>
                    {% else %}
                    <span style="color:var(--text-tertiary); font-size:0.875rem;">-</span>
                    {% endif %}
                </td>
                <td><span class="status-pill status-{{ lead.pipeline_status }}">{{ lead.pipeline_status|capitalize
                        }}</span></td>
                <td style="color:var(--text-secondary); font-size:0.75rem; padding-right:20px;">{{ lead.updated_at.strftime('%d %b') }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<script>
    const stats = {{ stats | tojson }};

    // Global Defaults for Minimal Charts
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    Chart.defaults.scale.grid.display = false;
    
    // 1. Funnel (Doughnut)
    new Chart(document.getElementById('funnelChart'), {
        type: 'doughnut',
        data: {
            labels: ['New', 'In Progress', 'Completed'],
            datasets: [{
                data: stats.funnel,
                backgroundColor: ['#e5e7eb', '#3b82f6', '#10b981'], // Gray, Blue, Green
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
            },
            cutout: '70%'
        }
    });

    // 2. Scores (Bar)
    new Chart(document.getElementById('qualityChart'), {
        type: 'bar',
        data: {
            labels: ['Top', 'Mid', 'Low'],
            datasets: [{
                label: 'Candidates',
                data: stats.scores,
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderRadius: 4,
                barThickness: 40
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f3f4f6', drawBorder: false } },
                x: { grid: { display: false } }
            }
        }
    });

    // 3. Sources (Pie)
    new Chart(document.getElementById('sourceChart'), {
        type: 'pie',
        data: {
            labels: stats.sources_labels,
            datasets: [{
                data: stats.sources_data,
                backgroundColor: ['#111827', '#4b5563', '#9ca3af', '#d1d5db', '#e5e7eb'], // Monochromes
                borderWidth: 0
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
            }
        }
    });
</script>
{% endblock %}